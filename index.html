<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ - ‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</title>
    <style>
        :root { 
            --primary: #1b5e20; 
            --secondary: #2e7d32; 
            --accent: #fbc02d; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --light: #f9fbe7; 
            --gold: #ffeb3b; 
            --white: #ffffff; 
            --purple: #8e44ad;
            --deep-blue: #0984e3;
            --glass: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Segoe UI', 'Iskoola Pota', sans-serif; margin: 0; background: var(--light); display: flex; }
        
        .sidebar { width: 280px; height: 100vh; background: var(--primary); color: white; position: fixed; overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.2); z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; padding: 25px 15px; background: #0a3d0e; color: var(--gold); font-weight: bold; font-size: 18px; border-bottom: 3px solid var(--gold); }
        .nav-link { padding: 15px 20px; display: block; color: #dcedc8; text-decoration: none; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; font-size: 15px; }
        .nav-link:hover, .nav-link.active { background: var(--secondary); color: var(--gold); border-left: 5px solid var(--gold); padding-left: 25px; }
        
        .main-content { margin-left: 280px; padding: 30px; width: calc(100% - 280px); position: relative; min-height: 100vh; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 35px; perspective: 1000px; }
        .stat-card { 
            padding: 30px; border-radius: 20px; color: white; text-align: center; 
            transition: transform 0.5s, box-shadow 0.5s; 
            transform-style: preserve-3d;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        .stat-card:hover { transform: rotateX(10deg) rotateY(-5deg) translateY(-10px); box-shadow: 0 20px 35px rgba(0,0,0,0.2); }
        .stat-card h5 { margin: 0; font-size: 16px; opacity: 0.9; text-transform: uppercase; }
        .stat-card h2 { margin: 10px 0 0; font-size: 32px; font-weight: 800; }

        .fund-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .fund-box { 
            padding: 20px; border-radius: 15px; color: white; text-align: center; font-weight: bold; 
            cursor: pointer; transition: 0.3s; border-bottom: 5px solid rgba(0,0,0,0.2);
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .fund-box:hover { transform: scale(1.05); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .fund-box small { font-size: 11px; opacity: 0.8; margin-top: 5px; }

        .school-header-banner { 
            background: linear-gradient(135deg, #1b5e20 0%, #388e3c 100%); 
            color: var(--gold); 
            padding: 20px 20px; 
            text-align: center; 
            border-radius: 25px; 
            margin-bottom: 35px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
            border: 2px solid var(--gold);
        }

        .card { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { color: var(--primary); border-left: 6px solid var(--accent); padding-left: 15px; margin-bottom: 25px; font-size: 24px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        th, td { padding: 15px; border: 1px solid #eee; text-align: left; }
        th { background: var(--primary); color: var(--gold); font-weight: 600; text-transform: uppercase; font-size: 13px; }
        tr:hover { background-color: #f1f8e9; }

        .q-table { width: 100%; border-collapse: collapse; border: 2px solid #2c3e50 !important; }
        .q-table th, .q-table td { border: 1px solid #bdc3c7 !important; padding: 10px 6px; font-size: 12px; }
        .q-header { background: #2c3e50 !important; color: #ffffff !important; text-align: center; font-weight: bold; text-transform: uppercase; }
        .val-col { text-align: right; font-weight: bold; width: 110px; background: #fdfefe; }
        .q-total-row { background: #ecf0f1 !important; font-weight: 800; border-top: 2px solid #2c3e50 !important; }

        .report-school-name { display: none; text-align: center; margin-bottom: 10px; }
        .report-school-name h1 { margin: 0; color: #1b5e20; font-size: 28px; }

        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .field { flex: 1; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--secondary); }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #dcedc8; border-radius: 10px; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 5px rgba(27, 94, 32, 0.2); }
        .btn { padding: 14px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:active { transform: scale(0.98); }

        .status-select { padding: 4px; font-size: 11px; border-radius: 5px; cursor: pointer; }
        .status-cleared { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }

        .creator-brand {
            margin-top: auto;
            padding: 30px 15px;
            text-align: center;
            background: #0a3d0e;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .creator-name {
            display: block;
            color: var(--gold);
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }
        .creator-sub { color: #aed581; font-size: 11px; }

        .code-tag-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .code-tag { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 12px; display: flex; align-items: center; }
        .code-num { background: var(--primary); color: var(--gold); padding: 4px 10px; border-radius: 6px; margin-right: 12px; font-family: monospace; font-weight: bold; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 10000; font-weight: bold; color: var(--primary); }

        @media print {
            @page { size: A4 landscape; margin: 10mm 5mm 10mm 5mm; }
            .sidebar, .no-print, .school-header-banner, button, .footer-credit { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 0 !important; width: 100% !important; }
            .card { box-shadow: none !important; border: none !important; padding: 0 !important; }
            .report-school-name { display: block !important; margin-bottom: 5px !important; text-align: center; }
            .report-school-name h1 { font-size: 20px !important; margin: 0 !important; padding: 0 !important; }
            #report-header-title { font-size: 18px !important; margin: 5px 0 !important; }
            #report-date-range { font-size: 12px !important; margin-bottom: 10px !important; }
            table, .q-table { width: 100% !important; border-collapse: collapse !important; font-size: 10pt !important; }
            th, td { padding: 4px 2px !important; border: 1px solid #333 !important; }
            tr { page-break-inside: avoid; }
        }

        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .admin-only, .staff-only { display: none; }
        
        .backup-btn { 
            background: #576574; 
            color: white; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding: 4px 8px !important; 
            font-size: 9px !important; 
            margin: 3px 15px; 
            border-radius: 6px;
            display: block;
            text-align: center;
        }
        .backup-btn:hover { background: #2c3e50; color: var(--gold); }
        .print-signatures { display: none; }

        @media print {
            .print-signatures { display: flex !important; justify-content: space-between; text-align: center; margin-top: 50px; width: 100%; }
            .sig-box { width: 30%; border-top: 1px solid #000; padding-top: 5px; font-size: 12px; }
        }

        /* Status indicators */
        /* ‡∂±‡∑Ä ‡∂ö‡∑ö‡∂≠‡∂∫ */
/* Rounded, 3D pill shape */
#connection-status { 
    padding: 12px 15px; 
    text-align: center; 
    font-size: 13px; 
    font-weight: 800; 
    border-radius: 50px; /* Fully rounded edges */
    margin: 15px; 
    letter-spacing: 1px;
    /* 3D bevel effect */
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow: 
        inset 0 2px 4px rgba(255,255,255,0.4), /* Highlight on top */
        inset 0 -2px 4px rgba(0,0,0,0.2),      /* Shadow on bottom */
        0 4px 10px rgba(0,0,0,0.3);            /* Outer shadow */
}

/* Online 3D Glow */
.status-glow-online { 
    background: linear-gradient(180deg, #2ecc71 0%, #27ae60 100%) !important; 
    color: white !important; 
    animation: pulse-glow 2s infinite; 
}

/* Offline 3D Look */
.status-glow-offline { 
    background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%) !important; 
    color: white !important; 
    /* Persistent red glow */
    box-shadow: 0 0 20px rgba(231, 76, 60, 0.8), inset 0 2px 4px rgba(255,255,255,0.4);
}
@keyframes pulse-glow {
    0% { 
        box-shadow: 0 0 15px rgba(46, 204, 113, 0.6), 0 4px 10px rgba(0,0,0,0.3); 
    }
    50% { 
        /* Increased blur to 50px and spread to 10px for a 'nuclear' glow */
        box-shadow: 0 0 20px 10px rgba(46, 204, 113, 1), 0 4px 15px rgba(0,0,0,0.4); 
    }
    100% { 
        box-shadow: 0 0 15px rgba(46, 204, 113, 0.6), 0 4px 10px rgba(0,0,0,0.3); 
    }
}
    </style>
</head>
<body>

<div id="loading-overlay">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑ê‡∂ö‡∑É‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì... ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±.</div>

<div id="login-overlay">
    <div class="card" style="text-align:center; width: 380px; padding: 50px;">
        <h2 style="color:var(--primary); margin-bottom: 5px;">‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h2>
        <p style="color: #666; margin-bottom: 30px;">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</p>
        <input type="password" id="passInput" placeholder="‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" style="text-align:center; margin-bottom:20px; font-size: 18px;">
        <button class="btn" style="width:100%; background: var(--primary); color: var(--gold);" onclick="checkLogin()">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        <div style="margin-top:30px;">
            <span style="color:var(--primary); font-weight: bold; font-size: 14px;">Created by: Tharanga Wijesinghe</span>
        </div>
    </div>
</div>

<div class="sidebar no-print">
    <div class="sidebar-header">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</div>
    <div id="connection-status" class="status-glow-offline">‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂≠‡∑è‡∑Ä‡∂∫ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...</div>
    <div style="padding-top: 10px;">
        <a class="nav-link active" id="nav-dash" onclick="showSec('dash')">üìä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä</a>
        <a class="nav-link staff-only" id="nav-entry" onclick="showSec('entry')">üìù ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</a>
        <a class="nav-link staff-only" id="nav-proj" onclick="showSec('proj')">üèóÔ∏è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫</a>
        <a class="nav-link" id="nav-cashbook" onclick="openReport('CASHBOOK')">üìö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠</a>
        <a class="nav-link" id="nav-inc" onclick="openReport('IN')">üìà ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" id="nav-exp" onclick="openReport('EX')">üìâ ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</a>
        <a class="nav-link" id="nav-variance" onclick="openReport('VARIANCE')">üìä ‡∂Ö‡∂∫‡∑Ä‡∑ê‡∂∫ ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏</a>
        <a class="nav-link" id="nav-quarter" onclick="openReport('QUARTER')">üìÖ ‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</a>
        <a class="nav-link" id="nav-bank" onclick="openReport('BANK')">üè¶ ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫</a>
        <a class="nav-link" id="nav-codes" onclick="showSec('codes')">üìë ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</a>
        
        <a class="nav-link" onclick="manualRefresh()" style="background: var(--deep-blue); color: white; margin-top: 10px; border-left: 5px solid var(--gold); display: flex; align-items: center;">üîÑ ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</a>
        
        <div style="margin-top: 20px; border-top: 2px solid var(--gold);">
            <a class="nav-link backup-btn" onclick="downloadBackupJSON()">üíΩ DATA BACKUP (JSON)</a>
            <a class="nav-link backup-btn" onclick="downloadBackupCSV()">üìú DATA DOWNLOAD (CSV)</a>
        </div>
    </div>
    
    <div style="padding: 20px;"><button class="btn" style="background:var(--danger); color:white; width:100%;" onclick="location.reload()">LOGOUT</button></div>
    
    <div class="creator-brand">
        <span class="creator-sub">Designed & Developed by</span>
        <span class="creator-name">THARANGA WIJESINGHE</span>
        <span class="creator-sub">¬© 2025 All Rights Reserved</span>
    </div>
</div>

<div class="main-content">
    <div class="school-header-banner">
        <h1 style="font-size: 60px; margin: 0;">‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</h1>
        <div style="margin-top: 10px; font-size: 30px; letter-spacing: 3px; opacity: 0.8;">‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</div>
    </div>

    <div id="sec-report" class="section" style="display:none;">
        <div id="printable-area" class="card">
            <div class="report-school-name">
                <h1>‡∂∏‡∑ú/‡∂ú‡∂∏‡∑ä‡∂¥‡∂Ç‡∂ú‡∑î‡∑Ä ‡∂ö‡∂±‡∑í‡∑Ç‡∑ä‡∂® ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑è‡∂Ω‡∂∫</h1>
                <p>‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∂ö‡∂ª‡∂´‡∂∫</p>
                <hr>
            </div>
            <h2 id="report-header-title" style="text-align:center; color: var(--primary);"></h2>
            <p id="report-date-range" style="text-align:center; font-weight:bold;"></p>
            <div id="report-content"></div>
            <div class="no-print" style="margin-top:30px; display:flex; gap:15px; background:#f9f9f9; padding:25px; border-radius:15px; border: 1px solid #eee;">
                <div class="field"><label>‡∑É‡∑í‡∂ß</label><input type="date" id="repFrom"></div>
                <div class="field"><label>‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è</label><input type="date" id="repTo"></div>
                <div class="field" id="filter-box" style="display:none;"><label>‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="repFilter"></select></div>
                <div class="field" id="bank-bal-box" style="display:none;">
                    <label>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫</label>
                    <input type="number" id="bankStmtInput" placeholder="0.00" oninput="generateReport()">
                </div>
                <button class="btn" style="align-self: flex-end; background: var(--primary); color: var(--gold);" onclick="generateReport()">‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±</button>
                <button class="btn" style="align-self: flex-end; background: var(--secondary); color: white;" onclick="window.print()">Print Report</button>
            </div>
        </div>
    </div>

    <div id="sec-dash" class="section">
        <h2 class="section-title">‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∂∏‡∑ñ‡∂Ω‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</h2>
        <div class="stat-grid">
            <div class="stat-card" style="background: var(--primary);">
                <h5>‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (DR)</h5>
                <h2 id="dash-in">0.00</h2>
            </div>
            <div class="stat-card" style="background: #a5d6a7; color: #1b5e20;">
                <h5>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (CR)</h5>
                <h2 id="dash-ex">0.00</h2>
            </div>
            <div class="stat-card" style="background: var(--accent); color: #1b5e20;">
                <h5>‡∂¥‡∑Ä‡∂≠‡∑ä‡∂±‡∑è ‡∑Å‡∑ö‡∑Ç‡∂∫</h5>
                <h2 id="dash-bal">0.00</h2>
            </div>
        </div>
        <div class="card" style="background: #fff; border-top: 4px solid var(--accent);">
            <h3 style="text-align: center; color: var(--primary); margin-bottom: 25px;">‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</h3>
            <div class="fund-grid" id="dash-funds"></div>
        </div>
    </div>

    <div id="sec-entry" class="section" style="display:none;">
        <h2 class="section-title">‡∂±‡∑Ä ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏</h2>
        <div class="form-row">
            <div class="card field" style="border-top: 8px solid var(--success);">
                <h3 style="color:var(--success); margin-top: 0;">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (‡∑Ñ‡∂ª)</h3>
                <input type="hidden" id="edit-id-in">
                <div class="form-row">
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="inDate"></div>
                    <div class="field"><label>‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="inRef"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="inCodeSelect"></select></div>
                    <div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</label><input type="number" id="inAmt"></div>
                </div>
                <div class="field" style="margin-bottom: 15px;"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="inProjSelect"></select></div>
                <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="inDesc" rows="2"></textarea>
                <button class="btn" style="margin-top:20px; width:100%; background: var(--success); color:white;" id="btn-save-in" onclick="saveData('IN')">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            </div>
            <div class="card field" style="border-top: 8px solid var(--danger);">
                <h3 style="color:var(--danger); margin-top: 0;">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (‡∂∂‡∑ê‡∂ª)</h3>
                <input type="hidden" id="edit-id-ex">
                <div class="form-row">
                    <div class="field"><label>‡∂Ø‡∑í‡∂±‡∂∫</label><input type="date" id="exDate"></div>
                    <div class="field"><label>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exVoucher"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</label><input type="text" id="exRef"></div>
                    <div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</label><input type="number" id="exAmt"></div>
                </div>
                <div class="form-row">
                    <div class="field"><label>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="exCodeSelect"></select></div>
                    <div class="field"><label>‡∂∏‡∑ñ‡∂Ω‡∑è‡∑Å‡∑ä‚Äç‡∂ª ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω</label><select id="exSourceSelect"></select></div>
                </div>
                <div class="field" style="margin-bottom: 15px;"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</label><select id="exProjSelect"></select></div>
                <label>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label><textarea id="exDesc" rows="2"></textarea>
                <button class="btn" style="margin-top:20px; width:100%; background: var(--danger); color:white;" id="btn-save-ex" onclick="saveData('EX')">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
        
        <div class="card admin-only">
            <h4 style="color:var(--primary); text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px;">‚öôÔ∏è ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂± ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä (Admin Only)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div style="border-right: 1px solid #eee; padding-right: 20px;">
                    <label><b>‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫‡∂±‡∑ä</b></label>
                    <div class="field"><label>‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω</label><select id="opCodeSelect"></select></div>
                    <div class="field"><label>‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="opAmt"></div>
                    <button class="btn" style="margin-top:10px; width:100%; background: var(--accent); color: var(--primary);" onclick="saveOpening()">‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑í‡∂±‡∑ä ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±</button>
                </div>
                <div>
                    <label><b>‡∑Ä‡∑è‡∂ª‡∑ä‡∑Ç‡∑í‡∂ö ‡∂Ö‡∂∫‡∑Ä‡∑ê‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂±</b></label>
                    <div class="field"><label>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</label><select id="allocCodeSelect"></select></div>
                    <div class="field"><label>‡∑Ä‡∑ô‡∂±‡∑ä‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø ‡∂∏‡∑î‡∂Ø‡∂Ω</label><input type="number" id="allocAmt"></div>
                    <button class="btn" style="margin-top:10px; width:100%; background: var(--purple); color: white;" onclick="saveAllocation()">‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂± ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">‡∂∏‡∑ë‡∂≠‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î</h3>
            <div id="recent-transactions-table" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="sec-proj" class="section" style="display:none;">
        <h2 class="section-title">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´‡∂∫</h2>
        <div class="card">
            <div class="form-row">
                <input type="hidden" id="edit-proj-id">
                <div class="field"><label>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫‡∑ö ‡∂±‡∂∏</label><input type="text" id="projName" placeholder="‡∂ã‡∂Ø‡∑è: ‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑ä‡∂Ω ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏"></div>
                <div class="field"><label>‡∂á‡∑É‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∂ú‡∂≠ ‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</label><input type="number" id="projEst"></div>
                <button class="btn" style="align-self: flex-end; background: var(--primary); color: var(--gold);" onclick="saveProject()">‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±</button>
            </div>
        </div>
        <div class="card"><div id="project-list-table"></div></div>
		<div id="proj-detail-view" class="card" style="display:none; border-top: 5px solid var(--primary);">
            <h3 id="detail-proj-name" style="color:var(--primary);"></h3>
            <div id="project-expenses-list"></div>
            <button class="btn" style="margin-top:20px; background:#95a5a6; color:white;" onclick="document.getElementById('proj-detail-view').style.display='none'">‡∂Ü‡∂¥‡∑É‡∑î</button>
        </div>
    </div>

    <div id="sec-codes" class="section" style="display:none;">
        <h2 class="section-title">‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª</h2>
        <div class="form-row">
            <div class="card field" style="border-top: 5px solid var(--primary);">
                <h3 style="color:var(--primary);">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (S-Codes)</h3>
                <div id="codes-s" class="code-tag-container"></div>
            </div>
            <div class="card field" style="border-top: 5px solid var(--danger);">
                <h3 style="color:var(--danger);">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠ (Expense Codes)</h3>
                <div id="codes-ex" class="code-tag-container"></div>
            </div>
        </div>
    </div>

    <div class="footer-credit no-print" style="text-align: center; color: #999; padding: 40px;">
        ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í ‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∑Ñ‡∑è ‡∂ö‡∑Ö‡∂∏‡∂±‡∑è‡∂ö‡∂ª‡∂´ : ‡∂≠‡∂ª‡∂Ç‡∂ú ‡∑Ä‡∑í‡∂¢‡∑ö‡∑É‡∑í‡∂Ç‡∑Ñ | 0777944308
    </div>
</div>



<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgMEK0OU2pbv84jerjbHuz80aN5pZ5V89FU7uJ8eGoOnQotXo8gvG89qdHLKVjvLrVhQ/exec";

    const S_CODES = ["S1","S2","S3","S4","S5","S6","S7","S8","S9","S10"];
    const EX_CODES = ["REx1","REx2","REx3","REx4","REx5","REx6","REx7","CEx1","CEx2","CEx3","CEx4","CEx5","CEx6"];
    const CODE_INFO = {
        "S1":"‡∂í‡∂ö‡∑è‡∂∂‡∂Ø‡∑ä‡∂∞ ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂¥‡∑Ö‡∑è‡∂≠‡∑ä ‡∑É‡∂∑‡∑è ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S2":"‡∑É‡∑Ñ‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∂ú‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏‡∑ä ‡∂∫‡∂ß‡∂≠‡∑ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∑Ä‡∂± ‡∑Ä‡∑ê‡∂©‡∑É‡∂ß‡∑Ñ‡∂±‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S3":"‡∂ª‡∂¢‡∂∫‡∑ö ‡∂Ü‡∂∞‡∑è‡∂ª", "S4":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∂¥‡∑è‡∂Ø‡∂ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∂Ø‡∑è‡∂±‡∂∫‡∂±‡∑ä, ‡∂ú‡∑î‡∂´‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂∫‡∑ô‡∂Ø‡∑Ä‡∑î‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∂ã‡∑É‡∑É‡∑ä ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S5":"‡∂ª‡∂¢‡∂∫ ‡∑Ä‡∑í‡∑É‡∑í‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∑Ñ‡∑è ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ª‡∑è‡∂¢‡∑ä‚Äç‡∂∫ ‡∂±‡∑ú‡∑Ä‡∂± ‡∑É‡∂Ç‡∑Ä‡∑í‡∂∞‡∑è‡∂± ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª", "S6":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑î‡∑Ä‡∑ô‡∂±‡∑ä ‡∑É‡∑ä‡∑Ä ‡∂ö‡∑ê‡∂∏‡∑ê‡∂≠‡∑ä‡∂≠‡∑ô‡∂±‡∑ä ‡∂Ø‡∑è‡∂∫‡∂ö‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂¥‡∑è‡∂ª‡∑ä‡∑Å‡∑Ä‡∂∫‡∂ö ‡∂¥‡∂ª‡∑í‡∂≠‡∑ä‚Äç‡∂∫‡∑è‡∂ú", "S7":"‡∂¥‡∑è‡∑É‡∂Ω‡∂ß ‡∂Ö‡∂∫‡∂≠‡∑ä ‡∑Ä‡∂≠‡∑ä‡∂ö‡∂∏‡∑ä ‡∑Ä‡∂Ω‡∑í‡∂±‡∑ä ‡∂ã‡∂¥‡∂∫‡∑è ‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä", "S8":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í ‡∑É‡∑è‡∂∏‡∑è‡∂¢‡∑í‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä", "S9":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂â‡∂ú‡∑ô‡∂±‡∑î‡∂∏‡∑ä ‡∂â‡∂ú‡∑ê‡∂±‡∑ä‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∑Ä‡∂Ω‡∑í‡∂∫‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä", "S10":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ä ‡∑É‡∂Ç‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∑É‡∂∏‡∑í‡∂≠‡∑í‡∂∫ ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂≠‡∑ì‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑î ‡∂Ω‡∂∂‡∂± ‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂¥‡∑í‡∂∫‡∑Ä‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∂± ‡∂Ö‡∂ª‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä",
        "REx1":"‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑î‡∂±‡∂ª‡∑è‡∑Ä‡∂ª‡∑ä‡∂≠‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "REx2":"‡∂ã‡∂¥‡∂Ø‡∑ö‡∑Å‡∂±, ‡∂ã‡∑É‡∑É‡∑ä ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∑É‡∂∏‡∂ú‡∑è‡∂∏‡∑ì ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä", "REx3":"‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂± ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂∫‡∑ù‡∂ú‡∑í‡∂≠‡∑è ‡∑É‡∑ö‡∑Ä‡∑è ‡∑Ñ‡∑è ‡∑É‡∑î‡∂∑‡∑É‡∑è‡∂∞‡∂± ‡∂ö‡∂ß‡∂∫‡∑î‡∂≠‡∑î", "REx4":"‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∂∏‡∂´‡∑ä‡∂©‡∂Ω ‡∂¥‡∑è‡∂ª‡∑í‡∑Å‡∑ä‚Äç‡∂ª‡∂∏‡∑í‡∂ö", "REx5":"‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂∑‡∑è‡∂´‡∑ä‡∂© ‡∑Ñ‡∑è ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è", "REx6":"‡∂¥‡∑è‡∑É‡∂Ω‡∑ö ‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∑É‡∑î‡∑Ö‡∑î ‡∂±‡∂©‡∂≠‡∑ä‡∂≠‡∑î/‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä‡∑Ä‡∑ê‡∂©‡∑í‡∂∫‡∑è", "REx7":"‡∂¥‡∑Ä‡∑í‡∂≠‡∑ä‚Äç‡∂ª‡∂≠‡∑è ‡∑Ñ‡∑è ‡∂¥‡∑í‡∂ª‡∑í‡∑É‡∑í‡∂Ø‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä", 
        "CEx1":"‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä - ‡∂±‡∑Ä ‡∑É‡∑ê‡∂¥‡∂∫‡∑ì‡∂∏‡∑ä", "CEx2":"‡∑Ä‡∑í‡∑Ç‡∂∫ ‡∂∏‡∑è‡∂Ω‡∑è ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "CEx3":"‡∂¥‡∑î‡∑É‡∑ä‡∂≠‡∂ö‡∑è‡∂Ω ‡∂¥‡∑ú‡∂≠‡∑ä ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä", "CEx4":"‡∂ú‡∑ú‡∂©‡∂±‡∑ê‡∂ú‡∑í‡∂Ω‡∑í ‡∂±‡∑Ä ‡∂â‡∂Ø‡∑í‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä, ‡∑Ä‡∑ê‡∂©‡∑í‡∂Ø‡∑í‡∂∫‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä ‡∑Ñ‡∑è ‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä", "CEx5":"‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂∏‡∑í‡∂Ω‡∂ß ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∑ä", "CEx6":"‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂¥‡∑ä‚Äç‡∂ª‡∑è‡∂ú‡∑ä‡∂∞‡∂± ‡∂Ü‡∂∞‡∑è‡∂ª"
    };
    const COLORS = ["#2e7d32", "#f9a825", "#388e3c", "#fbc02d", "#43a047", "#fdd835", "#4caf50", "#ffeb3b", "#66bb6a", "#ffee58"];

    let currentReport = '';
    let userRole = '';
    let allocations = JSON.parse(localStorage.getItem('sch_allocations') || '{}');
    let clearedStatus = JSON.parse(localStorage.getItem('sch_cleared') || '{}');
    let offlineQueue = JSON.parse(localStorage.getItem('sch_offline_queue') || '[]');
    let initialized = false;

    // Connection Watcher
    function updateOnlineStatus() {
        const statusDiv = document.getElementById('connection-status');
        if (navigator.onLine) {
            statusDiv.innerHTML = "üü¢ ONLINE";
            statusDiv.className = "status-glow-online";
            syncOfflineData();
        } else {
            statusDiv.innerHTML = "üî¥ OFFLINE";
            statusDiv.className = "status-glow-offline";
        }
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    async function checkLogin() {
        const pass = document.getElementById('passInput').value;
        if(pass === "MyApp") userRole = 'ADMIN';
        else if(pass === "Staff123") userRole = 'STAFF';
        else if(pass === "Guest") userRole = 'GUEST';
        else { alert("‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!"); return; }
        
        document.getElementById('login-overlay').style.display = 'none';
        applyPermissions();
        await init();
    }

    function applyPermissions() {
        if(userRole === 'ADMIN' || userRole === 'STAFF') {
            document.querySelectorAll('.staff-only').forEach(el => el.style.display = 'block');
        }
        if(userRole === 'ADMIN') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        }
    }

    async function init() {
        updateOnlineStatus();
        if (initialized) return;

        populateOptions();
        refreshDashboard();
        renderCodesList();
        updateProjectSelects();
        renderProjectList();
        loadRecentTable();

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('inDate').value = today;
        document.getElementById('exDate').value = today;
        document.getElementById('repFrom').value = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
        document.getElementById('repTo').value = today;

        await fetchRemoteData();
        await fetchRemoteProjects();
        
        initialized = true;
    }

    async function manualRefresh() { 
        toggleLoading(true);
        await fetchRemoteData(); 
        await fetchRemoteProjects(); 
        refreshDashboard(); 
        toggleLoading(false);
        alert("‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!"); 
    }
function editTransaction(id) {
    const db = getData();
    const entry = db.find(r => r.id === id);
    if(!entry) return;

    // Switch to Data Entry section
    showSec('entry');

    if(entry.type === 'IN') {
        document.getElementById('edit-id-in').value = entry.id;
        document.getElementById('inDate').value = entry.date.split('T')[0];
        document.getElementById('inRef').value = entry.ref;
        document.getElementById('inCodeSelect').value = entry.code;
        document.getElementById('inAmt').value = entry.amt;
        document.getElementById('inProjSelect').value = entry.proj;
        document.getElementById('inDesc').value = entry.desc;
        document.getElementById('btn-save-in').innerText = "‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Update)";
    } else {
        document.getElementById('edit-id-ex').value = entry.id;
        document.getElementById('exDate').value = entry.date.split('T')[0];
        document.getElementById('exVoucher').value = entry.vouch;
        document.getElementById('exRef').value = entry.ref;
        document.getElementById('exAmt').value = entry.amt;
        document.getElementById('exCodeSelect').value = entry.code;
        document.getElementById('exSourceSelect').value = entry.source;
        document.getElementById('exProjSelect').value = entry.proj;
        document.getElementById('exDesc').value = entry.desc;
        document.getElementById('btn-save-ex').innerText = "‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Update)";
    }
    
    // Scroll to top of the form
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
    async function fetchRemoteData() {
        try {
            const response = await fetch(SCRIPT_URL + "?action=read&t=" + Date.now());
            const remoteData = await response.json();
            
            // Merge logic: keep local unsynced data, replace others with server data
            let localDB = JSON.parse(localStorage.getItem('sch_db') || '[]');
            let unsynced = localDB.filter(item => item.synced === false);
            
            const merged = [...remoteData.map(d => ({...d, synced: true})), ...unsynced];
            localStorage.setItem('sch_db', JSON.stringify(merged));
            loadRecentTable();
            return merged;
    } catch (e) {
        return JSON.parse(localStorage.getItem('sch_db') || '[]');
    }
}

    async function fetchRemoteProjects() {
        try {
            const response = await fetch(SCRIPT_URL + "?action=read_projects&t=" + Date.now());
            const projects = await response.json();
            localStorage.setItem('sch_projs', JSON.stringify(projects));
            renderProjectList();
            updateProjectSelects();
        } catch (e) {}
    }

    function toggleLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function getData() { return JSON.parse(localStorage.getItem('sch_db') || '[]'); }
    function getProjects() { return JSON.parse(localStorage.getItem('sch_projs') || '[]'); }

    function populateOptions() {
        const selects = ['inCodeSelect', 'exSourceSelect', 'opCodeSelect'];
        selects.forEach(sId => {
            const el = document.getElementById(sId);
            if(el) {
                el.innerHTML = '';
                S_CODES.forEach(c => el.innerHTML += `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`);
            }
        });
        const exCodeSelects = ['exCodeSelect', 'allocCodeSelect'];
        exCodeSelects.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.innerHTML = '';
                EX_CODES.forEach(c => el.innerHTML += `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`);
            }
        });
    }

    function renderCodesList() {
        document.getElementById('codes-s').innerHTML = S_CODES.map(c => `<div class="code-tag"><span class="code-num">${c}</span>${CODE_INFO[c]}</div>`).join('');
        document.getElementById('codes-ex').innerHTML = EX_CODES.map(c => `<div class="code-tag"><span class="code-num" style="background:var(--danger); color:white;">${c}</span>${CODE_INFO[c]}</div>`).join('');
    }

async function saveData(type) {
    const prefix = type === 'IN' ? 'in' : 'ex';
    const existingId = document.getElementById('edit-id-' + prefix).value;
    
    // ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ID ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂á‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂ë‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂∫‡∑í, ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂∫‡∑í
    const currentId = existingId ? parseInt(existingId) : (Date.now() + Math.floor(Math.random()*1000));
    
    const data = { 
        action: 'save_transaction',
        id: currentId,
        date: document.getElementById(prefix + 'Date').value, 
        ref: document.getElementById(prefix + 'Ref').value, 
        vouch: type === 'EX' ? document.getElementById('exVoucher').value : '', 
        code: document.getElementById(prefix + 'CodeSelect').value, 
        amt: parseFloat(document.getElementById(prefix + 'Amt').value || 0), 
        desc: document.getElementById(prefix + 'Desc').value, 
        type: type, 
        source: type === 'EX' ? document.getElementById('exSourceSelect').value : document.getElementById('inCodeSelect').value,
        proj: document.getElementById(prefix + 'ProjSelect').value,
        status: true,
        isOp: false,
        synced: false
    };
    
    if(!data.date || data.amt <= 0) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑í‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");

    let db = getData();
    
    // --- ‡∂∏‡∑ô‡∂±‡∑ä‡∂± ‡∂∏‡∑ô‡∂≠‡∂±‡∂∫‡∑í ‡∑Ä‡∑ô‡∂±‡∑É ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ---
    const existingIndex = db.findIndex(item => item.id === currentId);
    if (existingIndex !== -1) {
        db[existingIndex] = data; // ‡∂≠‡∑í‡∂∂‡∑ô‡∂± ‡∂Ø‡∂≠‡∑ä‡∂≠‡∂∫ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂∫‡∑í
    } else {
        db.push(data); // ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠‡∂∫‡∂ö‡∑ä ‡∂Ω‡∑ô‡∑É ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂∫‡∑í
    }
    // -----------------------------------

    localStorage.setItem('sch_db', JSON.stringify(db));
    
    // Queue ‡∂ë‡∂ö‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ (Sync ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è)
    offlineQueue.push(data);
    localStorage.setItem('sch_offline_queue', JSON.stringify(offlineQueue));

    refreshDashboard();
    loadRecentTable();
    resetForms();
    
    // Button ‡∂ë‡∂ö‡∑ö ‡∂±‡∂∏ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∂≠‡∂≠‡∑ä‡∑Ä‡∂∫‡∂ß ‡∂¥‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    document.getElementById('btn-save-' + prefix).innerText = type === 'IN' ? "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏ ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" : "‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
    document.getElementById('edit-id-' + prefix).value = ''; 

    syncOfflineData();
}

    async function syncOfflineData() {
        if (!navigator.onLine || offlineQueue.length === 0) return;
        
        console.log("‡∑É‡∂∏‡∂∏‡∑î‡∑Ñ‡∑î‡∂ª‡∑ä‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∑Ä‡∑í‡∂∫...");
        const itemsToSync = [...offlineQueue];
        
        for (let item of itemsToSync) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(item)
                });
                
                if (response.ok) {
                    // Update LocalDB synced status
                    let db = getData();
                    let dbItem = db.find(d => d.id === item.id);
                    if (dbItem) dbItem.synced = true;
                    localStorage.setItem('sch_db', JSON.stringify(db));
                    
                    // Remove from queue
                    offlineQueue = offlineQueue.filter(q => q.id !== item.id);
                    localStorage.setItem('sch_offline_queue', JSON.stringify(offlineQueue));
                }
            } catch (e) {
                console.error("Sync error for ID: " + item.id);
                break; // Stop loop if server error
            }
        }
        loadRecentTable();
    }

    async function saveOpening() {
        const code = document.getElementById('opCodeSelect').value;
        const amt = parseFloat(document.getElementById('opAmt').value || 0);
        if(amt <= 0) return alert("‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");
        
        const data = { 
            action: 'save_transaction', 
            id: Date.now(), 
            date: "2024-01-01", 
            ref: 'OPENING', 
            vouch: '', 
            code: code, 
            amt: amt, 
            desc: '‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫', 
            type: 'IN', 
            source: code, 
            isOp: true, 
            status: true,
            synced: false
        };
        
        let db = getData();
        db.push(data);
        localStorage.setItem('sch_db', JSON.stringify(db));
        offlineQueue.push(data);
        localStorage.setItem('sch_offline_queue', JSON.stringify(offlineQueue));
        
        alert("‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑í‡∂´‡∑í!");
        refreshDashboard();
        syncOfflineData();
    }

    async function saveAllocation() {
        const code = document.getElementById('allocCodeSelect').value;
        const amt = parseFloat(document.getElementById('allocAmt').value || 0);
        toggleLoading(true);
        try { 
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: 'save_allocation', allocCode: code, allocAmt: amt}) }); 
            allocations[code] = amt; 
            localStorage.setItem('sch_allocations', JSON.stringify(allocations)); 
            alert("‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂± ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!"); 
        } catch (e) { alert("‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í!"); }
        toggleLoading(false);
    }

    function openReport(type) {
        currentReport = type;
        showSec('report');
        document.getElementById('filter-box').style.display = (type === 'IN' || type === 'EX') ? 'block' : 'none';
        document.getElementById('bank-bal-box').style.display = (type === 'BANK') ? 'block' : 'none';
        if(type === 'IN' || type === 'EX') {
            const list = type === 'IN' ? S_CODES : EX_CODES;
            document.getElementById('repFilter').innerHTML = '<option value="ALL">‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂ö‡∑ö‡∂≠‡∂∫‡∂±‡∑ä</option>' + list.map(c => `<option value="${c}">${c} - ${CODE_INFO[c]}</option>`).join('');
        }
        generateReport();
    }

    function generateReport() {
        const db = getData();
        const from = document.getElementById('repFrom').value;
        const to = document.getElementById('repTo').value;
        const filter = document.getElementById('repFilter').value;
        let html = '';

            if(currentReport === 'CASHBOOK') {
    document.getElementById('report-header-title').innerText = "‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠ (Cash Book)";
    let bal = db.filter(r => r.isOp).reduce((a,c) => a+c.amt, 0);
    if(from) { db.filter(r => !r.isOp && r.date < from).forEach(r => bal += (r.type==='IN'?r.amt:-r.amt)); }
    
    html = `<table><thead><tr>
                <th>‡∂Ø‡∑í‡∂±‡∂∫</th>
                <th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th>
                <th>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</th>
                <th>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª‡∑ä/‡∂Ω‡∂Ø‡∑î‡∂¥‡∂≠‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫</th>
                <th>‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (+)</th>
                <th>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (-)</th>
                <th>‡∑Å‡∑ö‡∑Ç‡∂∫</th>
            </tr></thead><tbody><tr style="background:#f0f0f0; font-weight:bold;"><td colspan="6" style="text-align:right">‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫:</td><td style="text-align:right">${bal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
    
    db.filter(r => !r.isOp && (!from || r.date >= from) && (!to || r.date <= to)).sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(r => {
        bal += (r.type === 'IN' ? r.amt : -r.amt);
        
        html += `<tr>
                    <td>${r.date.split('T')[0]}</td>
                    <td>${r.desc}</td>
                    <td>${r.ref || '-'}</td>
                    <td>${r.vouch || (r.type === 'IN' ? r.ref : '-')}</td>
                    <td style="text-align:right">${(r.type==='IN' && r.amt !== 0) ? r.amt.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
		    <td style="text-align:right">${(r.type==='EX' && r.amt !== 0) ? r.amt.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
		    <td style="text-align:right; font-weight:bold">${bal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                </tr>`;
    });
    html += '</tbody></table>';
} else if(currentReport === 'BANK') {
    document.getElementById('report-header-title').innerText = "‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫";
    let bankStmtBal = parseFloat(document.getElementById('bankStmtInput').value || 0);
    let filteredDb = db.filter(r => (!from || r.date >= from) && (!to || r.date <= to));

    // 1. ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä (Unpresented Cheques) - Pending ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä
    let unpresentedList = filteredDb.filter(r => r.type === 'EX' && (clearedStatus[r.id] || 'Pending') === 'Pending');
    let totalUnpresented = unpresentedList.reduce((a, b) => a + b.amt, 0);

    // 2. ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (Uncredited Deposits) - Pending ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä
    let uncreditedList = filteredDb.filter(r => r.type === 'IN' && (clearedStatus[r.id] || 'Pending') === 'Pending');
    let totalUncredited = uncreditedList.reduce((a, b) => a + b.amt, 0);

    let adjustedBalance = bankStmtBal + totalUncredited - totalUnpresented;

    // ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂±‡∂∫‡∑ö ‡∂Ü‡∂ö‡∑ò‡∂≠‡∑í‡∂∫ (Print-friendly format)
    html = `
        <div style="background: #ffffff; padding: 20px; border: 2px solid #333; border-radius: 5px; color: #000;">
            <h3 style="text-align:center; text-decoration: underline;">‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫ - ${to || '‡∂Ö‡∂Ø ‡∂Ø‡∑í‡∂±‡∂ß'}</h3>
            <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                <tr><td style="padding: 8px;"><b>‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫ ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Å‡∑ö‡∑Ç‡∂∫</b></td><td style="text-align:right; padding: 8px;"><b>${bankStmtBal.toLocaleString(undefined, {minimumFractionDigits: 2})}</b></td></tr>
                
                <tr><td colspan="2" style="padding: 8px; color: #1b5e20;"><b>‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏:</b> ‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂±‡∂∏‡∑î‡∂≠‡∑ä ‡∂±‡∑í‡∑Å‡∑ä‡∂ö‡∑è‡∑Ç‡∂´‡∂∫ ‡∂±‡∑ú‡∑Ä‡∑ñ ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä (Uncredited)</td></tr>`;
    
    uncreditedList.forEach(r => {
        html += `<tr><td style="padding-left:40px; font-size: 0.9em;">${r.date.split('T')[0]} - ${r.desc}</td><td style="text-align:right; padding-right: 20px;">${r.amt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
    });

    html += `<tr><td style="padding-left:80px;"><b>‡∂∏‡∑î‡∑Ö‡∑î ‡∂±‡∑í‡∑Å‡∑ä‡∂ö‡∑è‡∑Ç‡∂´‡∂∫ ‡∂±‡∑ú‡∑Ä‡∑ñ ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</b></td><td style="text-align:right; border-top:1px solid #000; padding: 8px;">${totalUncredited.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>
                <tr style="background:#f0f0f0;"><td style="padding: 8px;"><b>‡∂ã‡∂¥ ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</b></td><td style="text-align:right; padding: 8px;"><b>${(bankStmtBal + totalUncredited).toLocaleString(undefined, {minimumFractionDigits: 2})}</b></td></tr>
                
                <tr><td colspan="2" style="padding: 8px; color: #b71c1c;"><b>‡∂Ö‡∂©‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏:</b> ‡∂±‡∑í‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂±‡∂∏‡∑î‡∂≠‡∑ä ‡∂∂‡∑ê‡∂Ç‡∂ö‡∑î‡∑Ä‡∂ß ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ñ ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä (Unpresented)</td></tr>`;

    unpresentedList.forEach(r => {
        html += `<tr><td style="padding-left:40px; font-size: 0.9em;">${r.ref || '-'} (${r.date.split('T')[0]}) - ${r.desc}</td><td style="text-align:right; padding-right: 20px;">(${r.amt.toLocaleString(undefined, {minimumFractionDigits: 2})})</td></tr>`;
    });

    html += `<tr><td style="padding-left:80px;"><b>‡∂∏‡∑î‡∑Ö‡∑î ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂¥‡∂≠‡∑ä ‡∂±‡∑ú‡∂ö‡∑Ö ‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</b></td><td style="text-align:right; border-top:1px solid #000; padding: 8px;">(${totalUnpresented.toLocaleString(undefined, {minimumFractionDigits: 2})})</td></tr>
                <tr style="border-bottom: 4px double #000; background: #fff8e1;">
                    <td style="padding: 10px;"><b style="font-size:1.1em;">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ú‡∂≠‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ (Cash Book Balance)</b></td>
                    <td style="text-align:right; padding: 10px;"><b style="font-size:1.1em;">${adjustedBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}</b></td>
                </tr>
            </table>
        </div>

        <div class="no-print" style="margin-top:40px;">
            <hr>
            <h4>‡∂†‡∑ô‡∂ö‡∑ä‡∂¥‡∂≠‡∑ä ‡∑É‡∑Ñ ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Pending/Cleared)</h4>
            <p style="font-size: 0.9em; color: #666;">*‡∂∏‡∑ô‡∑Ñ‡∑í Pending ‡∂Ω‡∑ô‡∑É ‡∂á‡∂≠‡∑í ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂â‡∑Ñ‡∂≠ ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂ö‡∑è‡∑Å‡∂∫‡∂ß ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∑Ä‡∑ö.</p>
            <table class="q-table">
                <thead><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂Ö‡∂Ç‡∂ö‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</th><th>‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫</th></tr></thead><tbody>`;

    filteredDb.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
        let status = clearedStatus[r.id] || 'Pending';
        html += `<tr>
            <td>${r.date.split('T')[0]}</td>
            <td>${r.desc}</td>
            <td>${r.ref || (r.vouch || '-')}</td>
            <td class="val-col">${r.amt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
            <td>${r.type === 'IN' ? '‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏' : '‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏'}</td>
            <td>
                <select class="status-select ${status === 'Cleared' ? 'status-cleared' : 'status-pending'}" onchange="updateClearedStatus('${r.id}', this.value)">
                    <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Cleared" ${status === 'Cleared' ? 'selected' : ''}>Cleared</option>
                </select>
            </td>
        </tr>`;
    });
    html += `</tbody></table></div>`;
        } else if(currentReport === 'VARIANCE') {
            document.getElementById('report-header-title').innerText = "‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂± ‡∑É‡∑Ñ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑ê‡∑É‡∂≥‡∑î‡∂∏";
            html = `<table><tr><th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂±</th><th> ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th><th>‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫ %</th></tr>`;
            EX_CODES.forEach(c => {
                const actual = db.filter(r => r.type === 'EX' && r.code === c && (!from || r.date >= from) && (!to || r.date <= to)).reduce((a,b) => a+b.amt, 0);
                const budget = allocations[c] || 0;
                const balance = budget - actual;
                const perc = budget > 0 ? ((actual / budget) * 100).toFixed(1) : 0;
              html += `<tr><td><b>${c}</b> - ${CODE_INFO[c]}</td><td class="val-col">${budget > 0 ? budget.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td><td class="val-col">${actual > 0 ? actual.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td><td class="val-col">${balance !== 0 ? balance.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td><td style="text-align:center">${perc}%</td></tr>`;
            });
            html += '</table>';
       
} else if(currentReport === 'QUARTER') {
    document.getElementById('report-header-title').innerText = "‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É‡∑ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
    
    const fromDate = new Date(document.getElementById('repFrom').value);
    const toDate = new Date(document.getElementById('repTo').value);
    const yearStart = new Date(fromDate.getFullYear(), 0, 1); 

    const isFirstQuarter = fromDate.getMonth() === 0;

    let opBalTotal = db.filter(r => r.isOp).reduce((a, b) => a + b.amt, 0);
    let tinTotal = opBalTotal, texTotal = 0;

    html = `<table class="q-table">
        <thead>
            <tr>
                <th colspan="5" class="q-header">‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (‡∑Ñ‡∂ª)</th>
                <th colspan="5" class="q-header">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä (‡∂∂‡∑ê‡∂ª)</th>
            </tr>
            <tr>
                <th>‡∂ö‡∑ö‡∂≠‡∂∫</th>
                <th>‡∑Ä‡∑è‡∂ª‡∑ä‡∑Ç‡∑í‡∂ö ‡∂á‡∑É‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä</th>
                <th>‡∂¥‡∑ô‡∂ª ‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è</th>
                <th>‡∂∏‡∑ô‡∂∏ ‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É</th>
                <th>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</th>
                <th>‡∂ö‡∑ö‡∂≠‡∂∫</th>
                <th>‡∑Ä‡∑è‡∂ª‡∑ä‡∑Ç‡∑í‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂¥‡∑è‡∂Ø‡∂±</th>
                <th>‡∂¥‡∑ô‡∂ª ‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è</th>
                <th>‡∂∏‡∑ô‡∂∏ ‡∑É‡∑í‡∑Ä‡∑ä‡∂∏‡∑É</th>
                <th>‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</th>
            </tr>
        </thead>
        <tbody>`;

  const maxLength = Math.max(S_CODES.length, EX_CODES.length);

for (let i = 0; i < maxLength; i++) {
    let s = S_CODES[i] || '';
    let ex = EX_CODES[i] || '';
    let sOp = s ? db.filter(r => r.isOp && r.source === s).reduce((a, b) => a + b.amt, 0) : 0;
    let sPrev = s ? db.filter(r => r.type === 'IN' && !r.isOp && r.source === s && new Date(r.date) < fromDate).reduce((a, b) => a + b.amt, 0) : 0;
    let sCurr = s ? db.filter(r => r.type === 'IN' && r.source === s && new Date(r.date) >= fromDate && new Date(r.date) <= toDate).reduce((a, b) => a + b.amt, 0) : 0;
    let sTotalPrev = sOp + sPrev;
    let exPrev = ex ? db.filter(r => r.type === 'EX' && r.code === ex && new Date(r.date) < fromDate && new Date(r.date) >= yearStart).reduce((a, b) => a + b.amt, 0) : 0;
    let exCurr = ex ? db.filter(r => r.type === 'EX' && r.code === ex && new Date(r.date) >= fromDate && new Date(r.date) <= toDate).reduce((a, b) => a + b.amt, 0) : 0;
    tinTotal += (sPrev + sCurr); 
    texTotal += (exPrev + exCurr);
   html += `<tr>
    <td>${s}</td>
    <td class="val-col">-</td>
    <td class="val-col">${sTotalPrev > 0 ? sTotalPrev.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    <td class="val-col">${sCurr > 0 ? sCurr.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    <td class="val-col" style="background:#f9f9f9">${(sTotalPrev + sCurr) > 0 ? (sTotalPrev + sCurr).toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    
    <td>${ex}</td>
    <td class="val-col">${(allocations[ex] || 0) > 0 ? allocations[ex].toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    <td class="val-col">${exPrev > 0 ? exPrev.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    <td class="val-col">${exCurr > 0 ? exCurr.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
    <td class="val-col" style="background:#f9f9f9">${(exPrev + exCurr) > 0 ? (exPrev + exCurr).toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td>
</tr>`;
} 

    html += `<tr class="q-total-row">
        <td colspan="4">‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä (‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∑É‡∑Ñ‡∑í‡∂≠‡∑Ä)</td>
        <td class="val-col">${tinTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
        <td colspan="4">‡∂∏‡∑î‡∑Ö‡∑î ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</td>
        <td class="val-col">${texTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
    </tr>
    <tr class="q-total-row">
        <td colspan="9" style="text-align:right">‡∂Ö‡∂≠‡∑ê‡∂≠‡∑í ‡∑Å‡∑ö‡∑Ç‡∂∫ (Balance)</td>
        <td class="val-col" style="background:var(--gold)">${(tinTotal - texTotal).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
    </tr>
    </tbody></table>`;
        // ... ‡∂¥‡∑Ä‡∂≠‡∑í‡∂± ‡∂ö‡∑ö‡∂≠‡∂∫ ...
} else {
            document.getElementById('report-header-title').innerText = currentReport === 'IN' ? "‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä" : "‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑Å‡∑ä‡∂Ω‡∑ö‡∑Ç‡∂´ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä";
            const codes = filter === 'ALL' ? (currentReport === 'IN' ? S_CODES : EX_CODES) : [filter];
            
            if (currentReport === 'IN') {
                html = '<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th style="text-align:right;">‡∂∏‡∑î‡∑Ö‡∑î ‡∂Ω‡∑ê‡∂∂‡∑ì‡∂∏‡∑ä (‡∂ª‡∑î.)</th><th style="text-align:right;">‡∑Ä‡∑ê‡∂∫ ‡∂ö‡∑Ö ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ (‡∂ª‡∑î.)</th><th style="text-align:right;">‡∑Å‡∑ö‡∑Ç‡∂∫ (‡∂ª‡∑î.)</th></tr>';
            } else {
                html = '<table><tr><th>‡∂ö‡∑ö‡∂≠‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th style="text-align:right;">‡∂∏‡∑î‡∂Ø‡∂Ω (‡∂ª‡∑î.)</th></tr>';
            }

            let totalIn = 0, totalEx = 0;

            codes.forEach(c => { 
                const incomeAmt = db.filter(r => {
                    const isCorrectType = r.type === 'IN';
                    const isCorrectCode = (r.code === c || r.source === c);
                    const isWithinDate = (!from || r.date >= from) && (!to || r.date <= to);
                    return isCorrectType && isCorrectCode && (isWithinDate || r.isOp === true);
                }).reduce((a, b) => a + b.amt, 0);

                if (currentReport === 'IN') {
                    const expenseAmt = db.filter(r => r.type === 'EX' && r.source === c && (!from || r.date >= from) && (!to || r.date <= to)).reduce((a, b) => a + b.amt, 0);
                    const balance = incomeAmt - expenseAmt;
                    html += `<tr><td><b>${c}</b></td><td>${CODE_INFO[c]}</td><td class="val-col">${incomeAmt > 0 ? incomeAmt.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td><td class="val-col" style="color:red;">${expenseAmt > 0 ? expenseAmt.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td><td class="val-col" style="font-weight:bold;">${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`;
                    totalIn += incomeAmt;
                    totalEx += expenseAmt;
                } else {
                    html += `<tr><td><b>${c}</b></td><td>${CODE_INFO[c]}</td><td class="val-col">${incomeAmt > 0 ? incomeAmt.toLocaleString(undefined, {minimumFractionDigits: 2}) : '-'}</td></tr>`;
                    totalIn += incomeAmt;
                }
            });

            if (currentReport === 'IN') {
                html += `<tr style="background:#f1f2f6; font-weight:bold;"><td colspan="2">‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</td><td class="val-col">${totalIn.toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td class="val-col" style="color:red;">${totalEx.toLocaleString(undefined, {minimumFractionDigits: 2})}</td><td class="val-col">${(totalIn - totalEx).toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr></table>`;
            } else {
                html += `<tr style="background:#f1f2f6; font-weight:bold;"><td colspan="2">‡∂∏‡∑î‡∑Ö‡∑î ‡∂ë‡∂ö‡∂≠‡∑î‡∑Ä</td><td class="val-col">${totalIn.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr></table>`;
            }
        } // else ‡∂Ö‡∑Ä‡∑É‡∑è‡∂±‡∂∫

        html += `<div class="print-signatures"><div style="width: 33%;"><p>...</p><p><b>‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑Ö‡∑ö</b></p></div><div style="width: 33%;"><p>...</p><p><b>‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∑è‡∂ú‡∑è‡∂ª‡∑í‡∂ö</b></p></div><div style="width: 33%;"><p>...</p><p><b>‡∑Ä‡∑í‡∂Ø‡∑î‡∑Ñ‡∂Ω‡∑ä‡∂¥‡∂≠‡∑í</b></p></div></div>`;
        document.getElementById('report-content').innerHTML = html;
        document.getElementById('report-date-range').innerText = `‡∂ö‡∑è‡∂Ω‡∑É‡∑ì‡∂∏‡∑è‡∑Ä: ${(from || "‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑‡∂∫‡∑ö")} ‡∑É‡∑í‡∂ß ${(to || "‡∂Ö‡∂Ø")} ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∑è`;
    } // generateReport function ‡∂Ö‡∑Ä‡∑É‡∑è‡∂±‡∂∫

    function updateClearedStatus(id, val) {
        clearedStatus[id] = val;
        localStorage.setItem('sch_cleared', JSON.stringify(clearedStatus));
        generateReport();
    }
    async function refreshDashboard() {
        const db = await getData();
        const tin = db.filter(r => r.type === 'IN').reduce((a,b) => a + b.amt, 0);
        const tex = db.filter(r => r.type === 'EX').reduce((a,b) => a + b.amt, 0);
        document.getElementById('dash-in').innerText = tin.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('dash-ex').innerText = tex.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('dash-bal').innerText = (tin-tex).toLocaleString(undefined, {minimumFractionDigits:2});
        let fundHtml = '';
        S_CODES.forEach((s, i) => {
            const bal = db.filter(r => r.source === s).reduce((a,b) => a + (b.type==='IN'?b.amt:-b.amt), 0);
            fundHtml += `<div class="fund-box" style="background:${COLORS[i%COLORS.length]}"><div>${s}</div><div style="font-size:18px;">‡∂ª‡∑î. ${bal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div><small>${CODE_INFO[s]}</small></div>`;
        });
        document.getElementById('dash-funds').innerHTML = fundHtml;
    }

   async function loadRecentTable() {
    const db = await getData();
    let html = '<table><tr><th>‡∂Ø‡∑í‡∂±‡∂∫</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∑Ä‡∑Ä‡∑î‡∂†‡∂ª‡∑ä</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω</th><th>‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è</th></tr>';
    
    // Sort and show last 5 transactions
    db.sort((a,b) => b.id - a.id).slice(0,5).forEach(r => {
        let actions = [];
        
        // Edit permission: Admin and Staff
        if(userRole === 'ADMIN' || userRole === 'STAFF') {
            actions.push(`<button onclick="editTransaction(${r.id})" style="background:var(--deep-blue); color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Edit</button>`);
        }
        
        // Delete permission: Admin only
        if(userRole === 'ADMIN') {
            actions.push(`<button onclick="deleteData(${r.id})" style="background:var(--danger); color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Delete</button>`);
        }
        
        // Guest sees '-' if no permissions
        const actionHtml = actions.length > 0 ? actions.join(' ') : '-';

        html += `<tr>
            <td>${r.date.split('T')[0]}</td>
            <td>${r.desc}</td>
            <td>${r.vouch || r.ref}</td>
            <td style="color:${r.type==='IN'?'green':'red'}">${r.amt.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
            <td>${actionHtml}</td>
        </tr>`;
    });
    document.getElementById('recent-transactions-table').innerHTML = html + '</table>';
}

    async function saveProject() {
        const name = document.getElementById('projName').value, est = document.getElementById('projEst').value;
        if(!name || !est) return alert("‡∑Ñ‡∑í‡∑É‡∑ä‡∂≠‡∑ê‡∂±‡∑ä ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±");
        toggleLoading(true);
        try { 
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action:'saveProject', projectName:name, est:parseFloat(est)}) }); 
            alert("‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫ ‡∑É‡∑î‡∂ª‡∑ê‡∂ö‡∑í‡∂´‡∑í!"); 
            await fetchRemoteProjects(); 
        } catch(e) {}
        toggleLoading(false);
    }

    function renderProjectList() {
        const projs = getProjects(), db = getData();
        let html = '<table><tr><th>‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ò‡∂≠‡∑í‡∂∫</th><th>‡∂á‡∑É‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä</th><th>‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏</th><th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏</th><th>‡∑Å‡∑ö‡∑Ç‡∂∫</th></tr>';
        projs.forEach(p => {
            const pin = db.filter(r => r.proj === p.projectName && r.type === 'IN').reduce((a,b)=>a+b.amt,0);
            const pex = db.filter(r => r.proj === p.projectName && r.type === 'EX').reduce((a,b)=>a+b.amt,0);
			const projectBalance = (p.est + pin) - pex;
            html += `<tr><td>${p.projectName}</td><td>${p.est.toFixed(2)}</td><td>${pin.toFixed(2)}</td><td>${pex.toFixed(2)}</td><td><b>${(p.est + pin - pex).toFixed(2)}</b></td></tr>`;
        });
        document.getElementById('project-list-table').innerHTML = html + '</table>';
    }

    function updateProjectSelects() {
        const projs = getProjects();
        ['inProjSelect', 'exProjSelect'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</option>';
            projs.forEach(p => el.innerHTML += `<option value="${p.projectName}">${p.projectName}</option>`);
        });
    }

    async function deleteData(id) {
    if(!confirm("‡∂∏‡∂ö‡∂±‡∑ä‡∂±‡∂Ø?")) return;
    
    let localDB = JSON.parse(localStorage.getItem('sch_db') || '[]');
    localDB = localDB.filter(item => item.id !== id);
    localStorage.setItem('sch_db', JSON.stringify(localDB));
    
    loadRecentTable();
    refreshDashboard();

    try { 
        fetch(SCRIPT_URL + "?action=delete&id="+id); 
    } catch(e) { 
        console.error("Server delete failed");
    }
}

    function showSec(id) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('sec-' + id).style.display = 'block';
        document.getElementById('nav-' + id)?.classList.add('active');
        if(id === 'entry') loadRecentTable();
        if(id === 'proj') renderProjectList();
        if(id === 'dash') refreshDashboard();
    }

    async function manualRefresh() { await fetchRemoteData(); await fetchRemoteProjects(); refreshDashboard(); alert("‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!"); }

    function resetForms() {
	document.getElementById('edit-id-in').value = '';
   	 document.getElementById('edit-id-ex').value = '';
        document.querySelectorAll('input:not([type="hidden"]), textarea').forEach(i => i.value = '');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('inDate').value = today; document.getElementById('exDate').value = today;
    }

    function downloadBackupJSON() {
        const db = getData();
        const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click();
    }

    function downloadBackupCSV() {
        const db = getData();
        let csv = 'Date,Desc,Amt,Type,Code,Proj\n' + db.map(r => `${r.date},${r.desc},${r.amt},${r.type},${r.code},${r.proj}`).join('\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'data.csv'; a.click();
    }
</script>
</body>
</html>
